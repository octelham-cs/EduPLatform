@model EduPlatform.Core.Entities.Question
@{
    ViewData["Title"] = "تعديل السؤال";
    var subjects = ViewBag.Subjects as List<EduPlatform.Core.Entities.Subject>;
    var chapters = ViewBag.Chapters as List<EduPlatform.Core.Entities.Chapter>;
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex align-items-center mb-4">
                <a asp-action="Index" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-right"></i>
                </a>
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-edit text-primary ms-2"></i>
                        تعديل السؤال
                    </h2>
                    <p class="text-muted mb-0">تعديل بيانات السؤال في بنك الأسئلة</p>
                </div>
            </div>

            <form asp-action="Edit" method="post" id="questionForm">
                <input type="hidden" asp-for="Id" />

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">

                        <!-- اختيار نوع السؤال -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-list-ul text-primary ms-2"></i>
                                نوع السؤال <span class="text-danger">*</span>
                            </label>
                            <select asp-for="QuestionType" class="form-select form-select-lg" id="questionTypeSelect" required>
                                <option value="0">اختيار من متعدد (Multiple Choice)</option>
                                <option value="1">اختيارات متعددة (Multiple Select)</option>
                                <option value="2">صح/خطأ (True/False)</option>
                                <option value="3">توصيل (Matching)</option>
                                <option value="4">ترتيب (Ordering)</option>
                                <option value="5">إكمال الفراغات (Fill in the Blanks)</option>
                            </select>
                            <span asp-validation-for="QuestionType" class="text-danger"></span>
                        </div>

                        <hr class="my-4">

                        <!-- نص السؤال -->
                        <div class="mb-4">
                            <label asp-for="QuestionText" class="form-label fw-bold">
                                <i class="fas fa-question-circle text-primary ms-2"></i>
                                نص السؤال <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="QuestionText" class="form-control" rows="4"
                                      placeholder="اكتب السؤال هنا..." required></textarea>
                            <span asp-validation-for="QuestionText" class="text-danger"></span>
                        </div>

                        <!-- منطقة الاختيارات -->
                        <div id="optionsArea"></div>

                        <hr class="my-4">

                        <!-- المادة والفصل -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="SubjectId" class="form-label fw-bold">
                                    <i class="fas fa-book text-primary ms-2"></i>
                                    المادة <span class="text-danger">*</span>
                                </label>
                                <select asp-for="SubjectId" class="form-select" id="subjectSelect" required>
                                    <option value="">-- اختر المادة --</option>
                                    @if (subjects != null)
                                    {
                                        @foreach (var subject in subjects)
                                        {
                                            <option value="@subject.Id" selected="@(subject.Id == Model.SubjectId)">
                                                @subject.Name
                                            </option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="SubjectId" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="ChapterId" class="form-label fw-bold">
                                    <i class="fas fa-book-open text-primary ms-2"></i>
                                    الفصل (اختياري)
                                </label>
                                <select asp-for="ChapterId" class="form-select" id="chapterSelect">
                                    <option value="">-- اختر الفصل --</option>
                                    @if (chapters != null)
                                    {
                                        @foreach (var chapter in chapters)
                                        {
                                            <option value="@chapter.Id" selected="@(chapter.Id == Model.ChapterId)">
                                                @chapter.Title
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- مستوى الصعوبة -->
                        <div class="mb-4">
                            <label asp-for="DifficultyLevel" class="form-label fw-bold">
                                <i class="fas fa-chart-line text-primary ms-2"></i>
                                مستوى الصعوبة
                            </label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="range" asp-for="DifficultyLevel" class="form-range"
                                       min="1" max="5" id="difficultyRange">
                                <div class="difficulty-display">
                                    <span id="difficultyStars"></span>
                                    <small class="text-muted d-block" id="difficultyText"></small>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden fields -->
                        <input type="hidden" name="optionsJson" id="optionsJson">
                        <input type="hidden" name="correctAnswerJson" id="correctAnswerJson">
                        <input type="hidden" asp-for="CreatedAt">
                        <input type="hidden" asp-for="IsActive">

                    </div>
                    <div class="card-footer bg-light p-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-save ms-2"></i>
                            حفظ التعديلات
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg px-4">
                            <i class="fas fa-times ms-2"></i>
                            إلغاء
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // البيانات الحالية
        var currentOptionsJson = '@Html.Raw(Model.OptionsJson)';
        var currentCorrectAnswerJson = '@Html.Raw(Model.CorrectAnswerJson)';
        var currentQuestionType = @((int)Model.QuestionType);

        $(document).ready(function() {

            // تحديث واجهة الصعوبة
            updateDifficultyDisplay($('#difficultyRange').val());

            // تحميل الخيارات الحالية
            renderQuestionOptions(currentQuestionType, true);

            // تحديث الفصول عند اختيار المادة
            $('#subjectSelect').on('change', function() {
                var subjectId = $(this).val();
                var chapterSelect = $('#chapterSelect');

                chapterSelect.empty();
                chapterSelect.append('<option value="">-- اختر الفصل --</option>');

                if (subjectId) {
                    $.get('/Instructor/QuestionBank/GetChaptersBySubject', { subjectId: subjectId }, function(data) {
                        $.each(data, function(index, chapter) {
                            chapterSelect.append('<option value="' + chapter.id + '">' + chapter.name + '</option>');
                        });
                    });
                }
            });

            // تحديث نجوم الصعوبة
            $('#difficultyRange').on('input', function() {
                updateDifficultyDisplay($(this).val());
            });

            // تغيير نوع السؤال
            $('#questionTypeSelect').on('change', function() {
                var questionType = parseInt($(this).val());
                renderQuestionOptions(questionType, false);
            });

            // حفظ البيانات قبل الإرسال
            $('#questionForm').on('submit', function(e) {
                var questionType = parseInt($('#questionTypeSelect').val());
                var options = [];
                var correctAnswer = [];

                switch(questionType) {
                    case 0: // Multiple Choice
                        $('.option-input').each(function() {
                            options.push($(this).val());
                        });
                        correctAnswer = [parseInt($('input[name="correctOption"]:checked').val())];
                        break;

                    case 1: // Multiple Select
                        $('.option-input').each(function() {
                            options.push($(this).val());
                        });
                        $('.correct-checkbox:checked').each(function() {
                            correctAnswer.push(parseInt($(this).val()));
                        });
                        break;

                    case 2: // True/False
                        options = ['صح', 'خطأ'];
                        correctAnswer = [$('input[name="trueFalseAnswer"]:checked').val() === 'true' ? 0 : 1];
                        break;

                    case 5: // Fill in the Blanks
                        $('.blank-input').each(function() {
                            correctAnswer.push($(this).val());
                        });
                        options = correctAnswer;
                        break;
                }

                $('#optionsJson').val(JSON.stringify(options));
                $('#correctAnswerJson').val(JSON.stringify(correctAnswer));
            });
        });

        function updateDifficultyDisplay(level) {
            var stars = '';
            var text = '';

            for (var i = 1; i <= 5; i++) {
                stars += '<i class="fas fa-star ' + (i <= level ? 'text-warning' : 'text-muted') + '"></i> ';
            }

            switch(level) {
                case '1': text = 'سهل جداً'; break;
                case '2': text = 'سهل'; break;
                case '3': text = 'متوسط'; break;
                case '4': text = 'صعب'; break;
                case '5': text = 'صعب جداً'; break;
            }

            $('#difficultyStars').html(stars);
            $('#difficultyText').text(text);
        }

        function renderQuestionOptions(type, loadExisting) {
            var html = '';
            var existingOptions = loadExisting ? JSON.parse(currentOptionsJson) : [];
            var existingAnswers = loadExisting ? JSON.parse(currentCorrectAnswerJson) : [];

            switch(type) {
                case 0: // Multiple Choice
                    html = `
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-list text-primary ms-2"></i>
                                الاختيارات <span class="text-danger">*</span>
                            </label>
                            <div id="optionsList">`;

                    for (var i = 0; i < 4; i++) {
                        var optionValue = loadExisting && existingOptions[i] ? existingOptions[i] : '';
                        var isCorrect = loadExisting && existingAnswers.includes(i);

                        html += `
                            <div class="input-group mb-2">
                                <span class="input-group-text">
                                    <input type="radio" name="correctOption" value="${i}" ${isCorrect ? 'checked' : ''} required>
                                </span>
                                <input type="text" class="form-control option-input" value="${optionValue}"
                                       placeholder="الاختيار ${i + 1}" required>
                            </div>`;
                    }

                    html += `
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle ms-1"></i>
                                اختر الإجابة الصحيحة
                            </small>
                        </div>`;
                    break;

                case 1: // Multiple Select
                    html = `
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-check-square text-primary ms-2"></i>
                                الاختيارات <span class="text-danger">*</span>
                            </label>
                            <div id="optionsList">`;

                    for (var i = 0; i < 4; i++) {
                        var optionValue = loadExisting && existingOptions[i] ? existingOptions[i] : '';
                        var isCorrect = loadExisting && existingAnswers.includes(i);

                        html += `
                            <div class="input-group mb-2">
                                <span class="input-group-text">
                                    <input type="checkbox" class="correct-checkbox" value="${i}" ${isCorrect ? 'checked' : ''}>
                                </span>
                                <input type="text" class="form-control option-input" value="${optionValue}"
                                       placeholder="الاختيار ${i + 1}" required>
                            </div>`;
                    }

                    html += `
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle ms-1"></i>
                                اختر الإجابات الصحيحة (يمكن اختيار أكثر من واحدة)
                            </small>
                        </div>`;
                    break;

                case 2: // True/False
                    var isTrue = loadExisting && existingAnswers[0] === 0;

                    html = `
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-toggle-on text-primary ms-2"></i>
                                الإجابة الصحيحة <span class="text-danger">*</span>
                            </label>
                            <div class="d-flex gap-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="trueFalseAnswer"
                                           id="answerTrue" value="true" ${isTrue ? 'checked' : ''} required>
                                    <label class="form-check-label" for="answerTrue">
                                        <i class="fas fa-check-circle text-success ms-1"></i>
                                        صح
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="trueFalseAnswer"
                                           id="answerFalse" value="false" ${!isTrue ? 'checked' : ''}>
                                    <label class="form-check-label" for="answerFalse">
                                        <i class="fas fa-times-circle text-danger ms-1"></i>
                                        خطأ
                                    </label>
                                </div>
                            </div>
                        </div>`;
                    break;

                case 5: // Fill in the Blanks
                    html = `
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-pen text-primary ms-2"></i>
                                الإجابات الصحيحة <span class="text-danger">*</span>
                            </label>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb ms-2"></i>
                                استخدم [___] في نص السؤال لتحديد الفراغات
                            </div>
                            <div id="blanksList">`;

                    var blanksCount = loadExisting && existingAnswers.length > 0 ? existingAnswers.length : 1;

                    for (var i = 0; i < blanksCount; i++) {
                        var blankValue = loadExisting && existingAnswers[i] ? existingAnswers[i] : '';

                        html += `
                            <div class="input-group mb-2">
                                <span class="input-group-text">الفراغ ${i + 1}</span>
                                <input type="text" class="form-control blank-input" value="${blankValue}"
                                       placeholder="الإجابة الصحيحة" required>
                            </div>`;
                    }

                    html += `
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBlank()">
                                <i class="fas fa-plus ms-1"></i>
                                إضافة فراغ
                            </button>
                        </div>`;
                    break;
            }

            $('#optionsArea').html(html);
        }

        function addBlank() {
            var count = $('.blank-input').length + 1;
            var html = `
                <div class="input-group mb-2">
                    <span class="input-group-text">الفراغ ${count}</span>
                    <input type="text" class="form-control blank-input" placeholder="الإجابة الصحيحة" required>
                </div>`;
            $('#blanksList').append(html);
        }
    </script>

    <style>
        .difficulty-display {
            min-width: 150px;
        }

        .form-check-input:checked {
            background-color: #6366f1;
            border-color: #6366f1;
        }

        .input-group-text {
            min-width: 50px;
            justify-content: center;
        }
    </style>
}